[TOC]

## 1. 分布式架构概述

### 1.1 分布式架构简介

- <font color=red>分布式 和 集群的区别?</font>
    - **分布式**
        - 不同的多台服务器上面部署不同的服务模块,对外提供服务和组内协作。
    - **集群**
      - 不同的多台服务器上面部署相同的服务模块，通过分布式调度软件进行统一的调度，对外提供服务和访问

- <font color=red>什么是分布式架构?</font>

  - 不同的业务模块(功能模块) 分散部署在不同的服务器
  - 每个子系统负责一个或者多个不同的业务模块
  - 服务时间可以相互交互与通信 -> RPC/WebService /Http
  - 可以发展为集群分布式系统架构

  - <font color=blue>微服务是 分布式架构的一个子集!</font>

- <font color=red>分布式架构的优点?</font>

  - 实现业务解耦、系统模块化、提升系统的并发量

- <font color=red>分布式架构的缺点?</font>

  - 系统之间通信耗时、架构复杂、调试复杂

- <font color=red>设计原则</font>

  - 异步解耦
    - <font color=blue>可以通过消息队列MQ进行解耦</font>
  - 幂等一致性
    - <font color=blue>要保证用户同一个操作的不会在数据库中添加多个记录</font>
  - 拆分原则
  - 融合分布式中间件
  - 容错高可用

### 1.2 什么是NoSql?

- <font color=red>NoSql的特点?</font>
  - 易拓展、大数据量高性能、多样灵活的数据类型
- <font color=red>NoSql 数据库的分类?</font>
  - **K-V 键值对**
    - Redis、Memcache
  - **文档型数据库** 
    - CouchDB
    - MongoDB : 基于分布式文件存储的数据库,介于关系和非关系数据库之间
  - **列存储数据库**
    - HBase
  - **图形数据库 -> 构建关系图谱**
    - Neo4j
- <font color=red>**在分布式数据库中的CAP原理(CAP+BASE)**</font>
  - `CAP` -> 两者选其一
    - <font color=red>Consistency => 强一致性</font>
      - 在分布式系统中，所有的计算机节点的数据在同一时刻都是相同的，数据都是一致的
        - 不能因为分布式导致不同系统拿到的数据不一致。
          - 也就是说，用户在某一个节点写了数据，在其他节点获得该数据的值是最新的
          - 如若是更新操作，那么所有用户看到的也是更新后的新的值，不论哪个节点/集群/主备，获得的数据都是相同的
    - <font color=red>Availability=> 可用性</font>
      - 保证系统的可用
      - 也就是说无论任何时候，系统都可以被用户访问到，用户可以获得正常的响应结果
        - 比如做好集群/主备等等，这个就是高可用。
    - <font color=red>Partition tolerance=> 分区容错性</font>
      - 某个节点或者网络或者地域（分区）出现问题，整体整个系统还是照样能够提供一致性和可用性的服务
      - 部分系统故障不会影响整体
  - `BASE`
    - <font color=red>Basically Available => 基本可用</font>
    - <font color=red>Soft state => 软状态</font>
    - <font color=red>Eventually consistent => 最终一致性</font>

## 2. Redis 基础

### 2.1 Redis概述

- <font color=red>什么分布式缓存 ?</font>
  - 提升**读取速度性能**
  - 分布式计算领域
  - 为数据库库降低查询压力
  - **跨服务器缓存**
  - **内存式缓存**
- <font color=red>什么是Redis?</font>
  1. **分布式缓存中间件**
  2. **基于内存运行，数据存储在内存中**
  3. **支持数据的持久化,可以将内存中的数据持久化到硬盘，重启Redis的时候再次加载使用**
     - <font color=blue>Redis支持异步的将内存中的数据写到硬盘，同时不影响服务</font>
  4. **支持数据的备份** -> Master/Slave 模式的数据备份

- <font color=red>Redis 的优缺点?</font>
  - 优点
    - 丰富的数据结构
    - 可以将数据持久化到硬盘
    - 主从同步、故障转移
    - 基于计算机内存的数据库
  - 缺点: 单核、单线程

### 2.2 Redis安装

- <font color=red>Redis 默认安装目录: `/usr/local/bin`</font>

- <font color=red>**Redis 启动停止命令**</font>

  1. <font color=red>redis-server 配置文件</font>
  2. <font color=red>redis-cli -p 6379</font>
     - 如果Redis 设置了密码,需要登录客户端后,通过 `auth 密码` 的方式进行验证

- <font color=red>**操作步骤**</font>

  1. <font color=green>**Redis源码包解压缩**</font>

     ```shell
     tar -zxvf redis-5.0.5.tar.gz
     ```

  2. <font color=green>**安装 gcc-c++ 环境**</font>

     ```shell
     yum install gcc-c++ 
     ```

  3. <font color=green>**使用make进行编译**</font>

     ```shell
     make
     make install
     ```

  4. <font color=green>**设置Redis开机自启动**</font>

     - 在Redis解压包的utils下，<font color=red>拷贝redis_init_script到/etc/init.d目录</font>

     ```shell
     cp utils/redis_init_script /etc/init.d/
     ```

  5. <font color=green>**创建存放Redis 配置文件的目录 -> /usr/local/redis**</font>

     ```
     [root@localhost redis-5.0.5]# mkdir /usr/local/redis
     [root@localhost redis-5.0.5]# cp redis.conf /usr/local/redis/
     ```

  6. <font color=green>**修改Redis的配置文件**</font>

     - 设置Redis后台启动 => <font color=red>修改 daemonize no -> daemonize yes</font>

     ![image-20201006141941290](image/1.Redis%E6%A6%82%E8%BF%B0/image-20201006141941290.png)

     - 修改redis的工作目录

     ![image-20201006141949118](image/1.Redis%E6%A6%82%E8%BF%B0/image-20201006141949118.png)

     - 设置Redis允许远程连接,不受IP的限制

     ![image-20201006142005961](image/1.Redis%E6%A6%82%E8%BF%B0/image-20201006142005961.png)

     - 设置Redis的登录密码

     ![image-20201006142018541](image/1.Redis%E6%A6%82%E8%BF%B0/image-20201006142018541.png)

  7. <font color=green>**修改拷贝到/etc/init.d 下的`redis_init_script`,同时修改Redis配置文件的名字为**</font><font color=red>`6379.conf`</font>

     ![image-20201006142034409](image/1.Redis%E6%A6%82%E8%BF%B0/image-20201006142034409.png)
     
  8. <font color=green>**为redis启动脚本添加执行权限，随后运行启动redis**</font>
  
     ```shell
     [root@localhost init.d]# chmod 777 redis_init_script 
     [root@localhost init.d]# ./redis_init_script start
     [root@localhost init.d]# ps -ef |grep redis
     root      10027   3129  0 12:28 ?        00:00:00 /usr/local/bin/redis-server 0.0.0.0:6379
     ```
  
  9. <font color=green>**设置redis开机自启动，修改 `redis_init_script`，添加如下内容**</font>
  
     - 修改 `redis_init_script` 脚本
  
     ```shell
     #chkconfig: 22345 10 90
     #description: Start and Stop redis
     ```
  
     - 执行命令
  
     ```sh
     chkconfig redis_init_script on
     ```

### 2.3 Redis命令行常见命令

- [命令手册](http://redis.cn/commands.html)

- `select xxx` 
  - 切换数据库
  - <font color=blue>Redis 默认有`16` 个数据库,数据库角标从 0 开始</font>
- `dbsize`
  - 查看当前库中,键的数量
- `flushdb / flushall`
  - 分别是 清空当前库 和 清空所有的库

## 3. Redis 数据类型

- Redis包含了五种数据类型
  - `String` -> 字符串
  - `Hash` -> 哈希
  - `List` -> 列表
  - `Set` -> 集合
  - `Zset` -> 有序集合

- <font color=red>**Key 关键字**</font>
  - <font color=red>keys *</font> => 查看所有的key [不推荐!]
  - <font color=red>exists xxx</font> => 判断某一个key是不是存在
  - <font color=red>del xxx,xxx,...</font> => 删除给定的一个或者多个key
  - <font color=red>expire xxx 过期时间</font> => 为给定的key设置过期时间,单位是秒
  - <font color=red>ttl xxx</font> => 查看还有多少秒过期 (-1:永不过期  -2:已经过期)
  - <font color=red>type xxx</font> => 查看key是什么类型

### 3.1 String [单Key单Value]

#### 3.1.1 **常见命令手册**

| **命令**                                           | **说明**                                   |
| -------------------------------------------------- | ------------------------------------------ |
| <font color=red>get/del [key]</font>               | 查询删除某个key                            |
| <font color=red>set [key] [value]</font>           | 设置字符串,如果存在key,则覆盖value         |
| <font color=red>setnx [key] [value]</font>         | 当key不存在时,再设置字符串                 |
| <font color=red>set [key] [value] ex [time]</font> | 设置带过期时间的数据                       |
| <font color=red>mset/mget</font>                   | 连续设置值/获取值                          |
| <font color=red>getrange [key] start end</font>    | 截取字符串(角标从 0开始)。 [0,-1]:表示全部 |
| <font color=red>setrange [key] [newdata]</font>    | 从start位置开始替换数据                    |
| <font color=red>append [key] [value]</font>        | 对字符串进行追加                           |
| <font color=red>strlen [key]</font>                | 查看字符串长度                             |
| <font color=red>incr/desc [key]</font>             | 累加/累减 1 ->必须要是数值的字符串         |
| <font color=red>incrby/descby [key] [num]</font>   | 累加/累减 给定的数值                       |

#### 3.1.2 **String字符串操作示例**

```shell
#设置
127.0.0.1:6379> set age 22
OK
#累加
127.0.0.1:6379> incr age
(integer) 23
127.0.0.1:6379> get age
"23"
# 设置累加步长
127.0.0.1:6379> INCRBY age 5
(integer) 28
# 批量设置字符串
127.0.0.1:6379> mset name yoey slary 5000
OK
# 批量获取字符串
127.0.0.1:6379> mget age name slary
1) "28"
2) "yoey"
3) "5000"
# 字符串追加
127.0.0.1:6379> append name 123
(integer) 7
127.0.0.1:6379> get name
"yoey123"
# 字符串替换
127.0.0.1:6379> setrange name 4 456
(integer) 7
127.0.0.1:6379> get name
"yoey456"
# 字符串截取
127.0.0.1:6379> getrange name 0 3
"yoey"
```

### 3.2 Hash [Value 是多个键值对]

- 类似map，存储结构化数据结构,比如存储一个对象（==不能有嵌套对象==）

#### 3.2.1 **常见命令手册**

| **命令**                                                     | **说明**                          |
| ------------------------------------------------------------ | --------------------------------- |
| <font  color=red>hset [key] [property] [value]</font>        | 设置对象属性值                    |
| <font  color=red>hget [key] [property]</font>                | 获取对象属性值                    |
| <font  color=red>hmset [key] [property1] [value1] [property2] [value2]...</font> | 批量设置对象属性值                |
| <font  color=red>hmsetnx [key] [property1] [value1] [property2] [value2]...</font> | 批量设置对象属性值.不存在才会设置 |
| <font  color=red>hmget [key] [property1] [property2]…</font> | 批量获取对象属性值                |
| <font  color=red>hgetall [key]</font>                        | 获取整个对象的内容                |
| <font  color=red>hincrby [key] [property]</font>             | 累加属性                          |
| <font  color=red>hlen [key]</font>                           | 获取对象有多少属性                |
| <font  color=red>hexists [key] [property]</font>             | 判断对象中是否存在某个属性        |
| <font  color=red>hkeys [key] </font>                         | 获取对象的全部属性                |
| <font  color=red>hvals [key] </font>                         | 获取对象的所有属性值              |
| <font  color=red>hdel [key] [property1] [property2] ...</font> | 删除对象属性                      |

#### 3.2.2 **Hash操作示例**

```shell
# 设置对象属性值
127.0.0.1:6379> hset user name imooc
(integer) 1
127.0.0.1:6379> hset user age 18
(integer) 1
# 批量设置对象属性值
127.0.0.1:6379> hmset user sex man slary 5000
OK
# 获取对象某个属性值
127.0.0.1:6379> hget user name
"imooc"
# 批量获取对象属性值
127.0.0.1:6379> hmget user name age
1) "imooc"
2) "18"
# 判断对象属性值是否存在
127.0.0.1:6379> hexists user name
(integer) 1
# 获取对象的内容
127.0.0.1:6379> hgetall user
1) "name"
2) "imooc"
3) "age"
4) "18"
5) "sex"
6) "man"
7) "slary"
8) "5000"
# 获取对象所有的属性
127.0.0.1:6379> hkeys user
1) "name"
2) "age"
3) "sex"
4) "slary"
#获取对象所有的属性值
127.0.0.1:6379> Hvals user
1) "imooc"
2) "18"
3) "man"
4) "5000"
# 获取对象属性的数量
127.0.0.1:6379> hlen user
(integer) 4
```

### 3.3 List [单值多value]

- 它是一个字符串链表, left、right都可以插入添加 -> [a,b,c …]
  - 如果值全移除，对应的键也就消失了

#### 3.3.1 **常见命令手册**

| **命令**                                                     | **说明**                              |
| ------------------------------------------------------------ | ------------------------------------- |
| <font color=red>lpush/rpush [key] [value1] [value2]...</font> | 构建一个list，从左边/右边开始存入数据 |
| <font color=red>lrange [key] [start] [end]</font>            | 获取数据(角标从 0开始),[0,-1]获取全部 |
| <font color=red>lpop/rpop [key]</font>                       | 从左侧/右侧开始拿出一个数据           |
| <font color=red>llen [key]</font>                            | 获取list的长度                        |
| <font color=red>lindex [key] [index]</font>                  | 获取list指定下标的值                  |
| <font color=red>lset [key] [index] [value]</font>            | 替换list某个下标的值                  |
| <font color=red>linsert [key] before/after [existsValue] [value]</font> | 在现有值前/后插入一个新的值           |
| <font color=red>ltrim [key] [start] [end]</font>             | 截取指定范围的值后再赋值给list        |

#### 3.3.2 **List操作示例**

```shell
# 向左边添加数据
127.0.0.1:6379> lpush list aaa bbb ccc ddd
(integer) 4
# 获取数据
127.0.0.1:6379> lrange list 0 -1
1) "ddd"
2) "ccc"
3) "bbb"
4) "aaa"
# 向右边添加数据
127.0.0.1:6379> rpush list 111 222 333 444
(integer) 8
127.0.0.1:6379> lrange list 0 -1
1) "ddd"
2) "ccc"
3) "bbb"
4) "aaa"
5) "111"
6) "222"
7) "333"
8) "444"
# 设置某个角标的值
127.0.0.1:6379> lset list 0 DDD
OK
127.0.0.1:6379> lrange list 0 1
1) "DDD"
2) "ccc"
# 在某个值前/后 添加值
127.0.0.1:6379> linsert list before 111 000
(integer) 9
127.0.0.1:6379> lrange list 0 -1
1) "DDD"
2) "ccc"
3) "bbb"
4) "aaa"
5) "000"
6) "111"
7) "222"
8) "333"
9) "444"
```










